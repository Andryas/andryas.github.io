---
title: ""
subtitle: "From the series: real estate in Montreal"
author: Andryas Wavrzenczak
date: '2022-05-31'
slug: real-estates-montreal-styles
categories:
  - real-estates
tags:
  - real-estates
  - montreal
  - styles
comments: true
showTags: true
showPagination: true
showSocial: true
showDate: true
draft: true
# thumbnailImage: post/montreal-real-estate/data/thumbnail.jpg
thumbnailImagePosition: left
summary: ""
---

```{r setup, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  fig.height = 9,
  fig.width = 11
)
```

```{r libs}
library(tidyverse)
library(kableExtra)
library(wesanderson)
library(rgdal)
library(sf)
library(DT)
library(echarts4r)
library(geojsonsf)

library(aw)

prop <- as_tibble(readRDS("data/centris.ca/properties_montreal.rds"))
prop$tipology2 <- ifelse(prop$tipology == "house", "house", "condo")
prop <- prop |>
  filter(neighbourhood %in%
    (prop |>
      group_by(neighbourhood) |>
      count() |>
      ungroup() |>
      filter(n > 50) |>
      pull(neighbourhood))) |>
  select(
    url, price, tipology2, type,
    high_schools, primary_schools, transit_friendly, groceries,
    restaurants, pedestrian_friendly, greenery, historic,
    cycling_friendly, car_friendly, vibrant, shopping, daycares,
    nightlife, cafes, quiet, parks)
montreal <- readOGR("data/centris.ca/limadmin-shp/LIMADMIN.shp", verbose = FALSE) |>
  st_as_sf(crs = 4326)
montreal_json <- geojsonsf::sf_geojson(montreal |> rename(name = NOM))
```

```{r}
prop
```


Styles are properties attributes evaluated from 0 to 5. The website is from 0 to
10 because they are multiplied by two, I don't know why. The attributes are listed
below:

* high_schools
* primary_schools
* transit_friendly
* groceries
* restaurants
* pedestrian_friendly
* greenery
* historic
* cycling_friendly
* car_friendly
* vibrant
* shopping
* daycares
* nightlife
* cafes
* quiet
* parks

Each attribute measures one aspect of the properties; for example, high schools
measure how far the properties are from the high schools. The same
interpretation for the others. 

Now we have the same table above but now we add neighbourhood as group.

```{r}
simple_summarize(
  data = prop,
  var = c("high_schools", "primary_schools", "transit_friendly", "groceries",
    "restaurants", "pedestrian_friendly", "greenery", "historic",
    "cycling_friendly", "car_friendly", "vibrant", "shopping", "daycares",
    "nightlife", "cafes", "quiet", "parks"),
  neighbourhood
) |>
  mutate_at(vars(-var, -neighbourhood), round, 2) |>
  arrange(desc(min)) |>
  # kbl(digits = 4) |>
  # kable_styling(c('striped', 'hover')) |>
  # scroll_box(width="100%", height="500px")
  datatable(
    rownames = FALSE,
    filter = "top",
    caption = "Styles statistics by neighbourhood",
    options = list(
      dom = "plt",
      scrollX = TRUE
    )
  )
```

### Specifying Styles

Below I created a visualization for each style using the `average` to fill the neighbourhoods.

```{r}
styles <- c(
  "high_schools",
  "primary_schools",
  "transit_friendly",
  "groceries",
  "restaurants",
  "pedestrian_friendly",
  "greenery",
  "historic",
  "cycling_friendly",
  "car_friendly",
  "vibrant",
  "shopping",
  "daycares",
  "nightlife",
  "cafes",
  "quiet",
  "parks"
)

pal <- as.character(wes_palette("Zissou1", 5, type = "continuous"))
names(pal) <- c("[0,1]", "(1,2]", "(2,3]", "(3,4]", "(4,5]")

map(
  styles,
  function(.x) {
    prop2 <- prop |>
      select(neighbourhood, .x) |>
      group_by(neighbourhood) |>
      summarise_all(mean)
    colnames(prop2)[2] <- "value"

    montreal |>
      left_join(prop2, by = c("NOM" = "neighbourhood")) |>
      mutate(
        value = cut(value, seq(0, 5, 1), c("[0,1]", "(1,2]", "(2,3]", "(3,4]", "(4,5]"), include.lowest = TRUE),
        value = factor(value, c("[0,1]", "(1,2]", "(2,3]", "(3,4]", "(4,5]"))
      ) |>
      ggplot() +
      geom_sf(aes(fill = value)) +
      theme_minimal() +
      theme(legend.title = element_blank()) +
      scale_fill_manual(values = pal) +
      ggtitle(.x)
  }
)
```

# Best styles by neighbourhoods

```{r}
best_styles <- simple_summarize(
  data = prop,
  var = c("high_schools", "primary_schools", "transit_friendly", "groceries",
    "restaurants", "pedestrian_friendly", "greenery", "historic",
    "cycling_friendly", "car_friendly", "vibrant", "shopping", "daycares",
    "nightlife", "cafes", "quiet", "parks"),
  neighbourhood
) |>
  mutate_at(vars(-var, -neighbourhood), round, 2) |>
  arrange(desc(min)) |>
  ungroup() |>
  group_by(var) |>
  dplyr::filter(avg == max(avg))
```